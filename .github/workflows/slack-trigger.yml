name: Slack Command Handler

# This workflow receives repository_dispatch events from Slack
# and provides a simple slash command interface

on:
  repository_dispatch:
    types: [slack-command]

jobs:
  handle-slack-command:
    runs-on: ubuntu-latest
    steps:
      - name: Parse Slack Command
        id: parse
        run: |
          COMMAND="${{ github.event.client_payload.command }}"
          echo "command=$COMMAND" >> $GITHUB_OUTPUT

          # Extract browser and test file from command
          BROWSER=$(echo "$COMMAND" | grep -oP '(?<=--browser=)\w+' || echo "chromium")
          TEST_FILE=$(echo "$COMMAND" | grep -oP '(?<=--test=)\S+' || echo "")

          echo "browser=$BROWSER" >> $GITHUB_OUTPUT
          echo "test_file=$TEST_FILE" >> $GITHUB_OUTPUT

      - name: Trigger Playwright Tests
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: run-e2e-tests
          client-payload: |
            {
              "browser": "${{ steps.parse.outputs.browser }}",
              "test_file": "${{ steps.parse.outputs.test_file }}",
              "user": "${{ github.event.client_payload.user_name }}"
            }
